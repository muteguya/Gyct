<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CIUE · Admin Panel</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: #f0f2f5;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Admin Header */
    .admin-header {
      background: linear-gradient(135deg, #7d5ba6, #b8a3d9);
      color: white;
      padding: 25px;
      border-radius: 20px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 25px rgba(125,91,166,0.3);
    }

    .admin-header h1 {
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-header h1 i {
      font-size: 2.5rem;
    }

    .admin-header .stats {
      background: rgba(255,255,255,0.2);
      padding: 12px 25px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Login Form */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      border-radius: 30px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.1);
      text-align: center;
    }

    .login-container h2 {
      color: #4a3b5e;
      margin-bottom: 30px;
      font-size: 1.8rem;
    }

    .login-container .input-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .login-container label {
      display: block;
      color: #4a3b5e;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .login-container input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0d0eb;
      border-radius: 15px;
      font-size: 1rem;
      outline: none;
    }

    .login-container input:focus {
      border-color: #7d5ba6;
    }

    .login-btn {
      background: linear-gradient(135deg, #7d5ba6, #b8a3d9);
      color: white;
      border: none;
      width: 100%;
      padding: 15px;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(125,91,166,0.3);
    }

    .error-message {
      color: #dc3545;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
    }

    /* Admin Dashboard */
    .admin-dashboard {
      display: none;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .stat-icon.pending {
      background: #fff3cd;
      color: #856404;
    }

    .stat-icon.approved {
      background: #d4edda;
      color: #155724;
    }

    .stat-icon.total {
      background: #cce5ff;
      color: #004085;
    }

    .stat-icon.users {
      background: #e6f7ff;
      color: #0066cc;
    }

    .stat-info h3 {
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .stat-info .number {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
    }

    /* Section Tabs */
    .section-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 10px;
      border-radius: 50px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 40px;
      background: transparent;
      color: #666;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: #7d5ba6;
      color: white;
    }

    .tab-btn i {
      font-size: 1.1rem;
    }

    /* Content Sections */
    .content-section {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .content-section.active {
      display: block;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      color: #4a3b5e;
      font-size: 1.4rem;
    }

    .refresh-btn {
      background: #7d5ba6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .refresh-btn:hover {
      background: #6a4b8f;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 15px 10px;
      background: #f8f9fa;
      color: #4a3b5e;
      font-weight: 600;
      font-size: 0.9rem;
      border-radius: 10px 10px 0 0;
    }

    td {
      padding: 15px 10px;
      border-bottom: 1px solid #eaeaea;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .approve-btn, .reject-btn, .view-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .approve-btn {
      background: #28a745;
      color: white;
    }

    .approve-btn:hover {
      background: #218838;
    }

    .reject-btn {
      background: #dc3545;
      color: white;
    }

    .reject-btn:hover {
      background: #c82333;
    }

    .view-btn {
      background: #7d5ba6;
      color: white;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-style: italic;
    }

    /* Logout Button */
    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.5);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      max-width: 400px;
      width: 90%;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
    }

    .modal-content h3 {
      color: #4a3b5e;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .modal-content p {
      color: #666;
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .modal-btns {
      display: flex;
      gap: 10px;
    }

    .confirm-btn, .cancel-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .confirm-btn {
      background: #28a745;
      color: white;
    }

    .confirm-btn:hover {
      background: #218838;
    }

    .cancel-btn {
      background: #6c757d;
      color: white;
    }

    .cancel-btn:hover {
      background: #5a6268;
    }

    /* User Details Modal */
    .user-details {
      text-align: left;
      margin: 20px 0;
    }

    .user-details p {
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }

    .user-details strong {
      color: #4a3b5e;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
      <h2><i class="fas fa-crown" style="color: #7d5ba6;"></i> Admin Login</h2>
      <div class="input-group">
        <label><i class="fas fa-user"></i> Username</label>
        <input type="text" id="adminUsername" placeholder="Enter admin username" value="admin">
      </div>
      <div class="input-group">
        <label><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="adminPassword" placeholder="Enter admin password" value="admin123">
      </div>
      <button class="login-btn" onclick="adminLogin()">
        <i class="fas fa-sign-in-alt"></i> Login to Dashboard
      </button>
      <div id="loginError" class="error-message">Invalid username or password</div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-dashboard">
      <!-- Header -->
      <div class="admin-header">
        <h1>
          <i class="fas fa-crown"></i>
          CIUE Admin Panel
        </h1>
        <div style="display: flex; gap: 15px; align-items: center;">
          <span class="stats" id="pendingCount">Pending: 0</span>
          <button class="logout-btn" onclick="adminLogout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon users">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3>Total Users</h3>
            <div class="number" id="statUsers">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon pending">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3>Pending Deposits</h3>
            <div class="number" id="statPending">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon pending">
            <i class="fas fa-hand-holding-usd"></i>
          </div>
          <div class="stat-info">
            <h3>Pending Withdrawals</h3>
            <div class="number" id="statWithdrawals">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon total">
            <i class="fas fa-coins"></i>
          </div>
          <div class="stat-info">
            <h3>Total Deposits</h3>
            <div class="number" id="statTotal">0</div>
          </div>
        </div>
      </div>

      <!-- Section Tabs -->
      <div class="section-tabs">
        <button class="tab-btn active" onclick="switchTab('deposits')" id="tabDeposits">
          <i class="fas fa-credit-card"></i> Deposits
        </button>
        <button class="tab-btn" onclick="switchTab('withdrawals')" id="tabWithdrawals">
          <i class="fas fa-hand-holding-usd"></i> Withdrawals
        </button>
        <button class="tab-btn" onclick="switchTab('users')" id="tabUsers">
          <i class="fas fa-users"></i> Users
        </button>
      </div>

      <!-- Deposits Section -->
      <div id="depositsSection" class="content-section active">
        <div class="section-header">
          <h2><i class="fas fa-credit-card"></i> Deposit Requests</h2>
          <button class="refresh-btn" onclick="loadDeposits()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        <div class="table-container">
          <table id="depositsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>User</th>
                <th>Phone</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="depositsBody">
              <tr>
                <td colspan="6" class="no-data">No deposit requests found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Withdrawals Section -->
      <div id="withdrawalsSection" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-hand-holding-usd"></i> Withdrawal Requests</h2>
          <button class="refresh-btn" onclick="loadWithdrawals()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        <div class="table-container">
          <table id="withdrawalsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>User</th>
                <th>Phone</th>
                <th>Amount</th>
                <th>Wallet</th>
                <th>Mobile</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="withdrawalsBody">
              <tr>
                <td colspan="8" class="no-data">No withdrawal requests found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Users Section -->
      <div id="usersSection" class="content-section">
        <div class="section-header">
          <h2><i class="fas fa-users"></i> Registered Users</h2>
          <button class="refresh-btn" onclick="loadUsers()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Level</th>
                <th>Operating</th>
                <th>Incentive</th>
                <th>Referral Code</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr>
                <td colspan="7" class="no-data">No users found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">Confirm Action</h3>
      <p id="modalMessage">Are you sure?</p>
      <div class="modal-btns">
        <button class="confirm-btn" id="modalConfirmBtn" onclick="executeAction()">Confirm</button>
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-user-circle"></i> User Details</h3>
      <div id="userDetails" class="user-details"></div>
      <button class="cancel-btn" onclick="closeUserModal()" style="width: 100%;">Close</button>
    </div>
  </div>

  <script>
    // ========== ADMIN CREDENTIALS ==========
    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = 'admin123';

    // ========== GLOBAL VARIABLES ==========
    let pendingAction = null;
    let selectedId = null;
    let selectedType = null;
    let selectedAmount = null;
    let selectedUserId = null;

    // ========== LOGIN FUNCTION ==========
    function adminLogin() {
      const username = document.getElementById('adminUsername').value;
      const password = document.getElementById('adminPassword').value;

      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('loginError').style.display = 'none';
        
        // Load all data
        loadAllData();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    // ========== LOGOUT FUNCTION ==========
    function adminLogout() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('adminDashboard').style.display = 'none';
    }

    // ========== TAB SWITCHING ==========
    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
      
      // Update sections
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      document.getElementById(`${tab}Section`).classList.add('active');
      
      // Load data for the tab
      if (tab === 'deposits') loadDeposits();
      else if (tab === 'withdrawals') loadWithdrawals();
      else if (tab === 'users') loadUsers();
    }

    // ========== LOAD ALL DATA ==========
    function loadAllData() {
      loadStats();
      loadDeposits();
      loadWithdrawals();
      loadUsers();
    }

    // ========== LOAD STATISTICS ==========
    function loadStats() {
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      const deposits = JSON.parse(localStorage.getItem('pendingDeposits')) || [];
      const withdrawals = JSON.parse(localStorage.getItem('pendingWithdrawals')) || [];
      
      const pendingDeposits = deposits.filter(d => !d.status || d.status === 'pending').length;
      const pendingWithdrawals = withdrawals.filter(w => !w.status || w.status === 'pending').length;
      
      document.getElementById('statUsers').textContent = Object.keys(users).length;
      document.getElementById('statPending').textContent = pendingDeposits;
      document.getElementById('statWithdrawals').textContent = pendingWithdrawals;
      document.getElementById('statTotal').textContent = deposits.length;
      document.getElementById('pendingCount').textContent = `Pending: ${pendingDeposits + pendingWithdrawals}`;
    }

    // ========== LOAD DEPOSITS ==========
    function loadDeposits() {
      const deposits = JSON.parse(localStorage.getItem('pendingDeposits')) || [];
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      
      const tbody = document.getElementById('depositsBody');
      
      if (deposits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No deposit requests found</td></tr>';
        return;
      }

      let html = '';
      
      // Sort by date (newest first)
      deposits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      deposits.forEach(deposit => {
        const user = users[deposit.userId] || { fullName: 'Unknown', phone: deposit.phone || 'Unknown' };
        const date = new Date(deposit.timestamp).toLocaleString();
        const statusClass = !deposit.status || deposit.status === 'pending' ? 'status-pending' : 
                           deposit.status === 'approved' ? 'status-approved' : 'status-rejected';
        const statusText = !deposit.status || deposit.status === 'pending' ? 'PENDING' : 
                          deposit.status === 'approved' ? 'APPROVED' : 'REJECTED';
        
        html += `<tr>
          <td>${date}</td>
          <td>${user.fullName || 'Unknown'}</td>
          <td>${user.phone || deposit.phone || 'Unknown'}</td>
          <td><strong>${deposit.amount?.toLocaleString() || 0} UGX</strong></td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>`;
        
        if (!deposit.status || deposit.status === 'pending') {
          html += `
            <div class="action-btns">
              <button class="approve-btn" onclick="openApproveModal('deposit', '${deposit.id}', ${deposit.amount}, '${deposit.userId}')">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="reject-btn" onclick="openRejectModal('deposit', '${deposit.id}')">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          `;
        } else {
          html += `<span style="color: #999;">No action</span>`;
        }
        
        html += `</td></tr>`;
      });
      
      tbody.innerHTML = html;
    }

    // ========== LOAD WITHDRAWALS ==========
    function loadWithdrawals() {
      const withdrawals = JSON.parse(localStorage.getItem('pendingWithdrawals')) || [];
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      
      const tbody = document.getElementById('withdrawalsBody');
      
      if (withdrawals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No withdrawal requests found</td></tr>';
        return;
      }

      let html = '';
      
      withdrawals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      withdrawals.forEach(withdrawal => {
        const user = users[withdrawal.userId] || { fullName: 'Unknown', phone: 'Unknown' };
        const date = new Date(withdrawal.timestamp).toLocaleString();
        const statusClass = !withdrawal.status || withdrawal.status === 'pending' ? 'status-pending' : 
                           withdrawal.status === 'approved' ? 'status-approved' : 'status-rejected';
        const statusText = !withdrawal.status || withdrawal.status === 'pending' ? 'PENDING' : 
                          withdrawal.status === 'approved' ? 'APPROVED' : 'REJECTED';
        
        html += `<tr>
          <td>${date}</td>
          <td>${user.fullName || 'Unknown'}</td>
          <td>${user.phone || 'Unknown'}</td>
          <td><strong>${withdrawal.amount?.toLocaleString() || 0} UGX</strong></td>
          <td>${withdrawal.wallet?.toUpperCase() || 'N/A'}</td>
          <td>${withdrawal.mobileNumber || 'N/A'}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>`;
        
        if (!withdrawal.status || withdrawal.status === 'pending') {
          html += `
            <div class="action-btns">
              <button class="approve-btn" onclick="openApproveModal('withdrawal', '${withdrawal.id}', ${withdrawal.amount}, '${withdrawal.userId}', '${withdrawal.wallet}')">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="reject-btn" onclick="openRejectModal('withdrawal', '${withdrawal.id}')">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          `;
        } else {
          html += `<span style="color: #999;">No action</span>`;
        }
        
        html += `</td></tr>`;
      });
      
      tbody.innerHTML = html;
    }

    // ========== LOAD USERS ==========
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      
      const tbody = document.getElementById('usersBody');
      
      if (Object.keys(users).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No users found</td></tr>';
        return;
      }

      let html = '';
      
      Object.values(users).forEach(user => {
        const levelText = user.memberLevel === 0 ? 'Intern' : `D${user.memberLevel}`;
        
        html += `<tr>
          <td>${user.fullName || 'Unknown'}</td>
          <td>${user.phone || 'Unknown'}</td>
          <td>${levelText}</td>
          <td>${(user.operatingWallet || 0).toLocaleString()} UGX</td>
          <td>${(user.incentiveWallet || 0).toLocaleString()} UGX</td>
          <td>${user.referralCode || 'N/A'}</td>
          <td>
            <button class="view-btn" onclick="viewUser('${user.phone}')">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        </tr>`;
      });
      
      tbody.innerHTML = html;
    }

    // ========== VIEW USER DETAILS ==========
    function viewUser(phone) {
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      const user = users[phone];
      
      if (!user) return;
      
      const levelText = user.memberLevel === 0 ? 'Intern' : `D${user.memberLevel}`;
      const daysLeft = Math.ceil((new Date(user.memberExpiry) - new Date()) / (1000*60*60*24));
      
      const html = `
        <p><strong>Full Name:</strong> ${user.fullName}</p>
        <p><strong>Phone:</strong> ${user.phone}</p>
        <p><strong>Country:</strong> ${user.country || 'N/A'}</p>
        <p><strong>Member Level:</strong> ${levelText}</p>
        <p><strong>Days Left:</strong> ${daysLeft}</p>
        <p><strong>Operating Wallet:</strong> ${(user.operatingWallet || 0).toLocaleString()} UGX</p>
        <p><strong>Incentive Wallet:</strong> ${(user.incentiveWallet || 0).toLocaleString()} UGX</p>
        <p><strong>Referral Code:</strong> ${user.referralCode || 'N/A'}</p>
        <p><strong>Referred By:</strong> ${user.referredBy || 'None'}</p>
        <p><strong>Registered:</strong> ${new Date(user.registeredDate).toLocaleDateString()}</p>
      `;
      
      document.getElementById('userDetails').innerHTML = html;
      document.getElementById('userModal').style.display = 'flex';
    }

    function closeUserModal() {
      document.getElementById('userModal').style.display = 'none';
    }

    // ========== MODAL FUNCTIONS ==========
    function openApproveModal(type, id, amount, userId, wallet = null) {
      selectedType = type;
      selectedId = id;
      selectedAmount = amount;
      selectedUserId = userId;
      selectedWallet = wallet;
      
      document.getElementById('modalTitle').textContent = 'Confirm Approval';
      document.getElementById('modalMessage').textContent = `Are you sure you want to approve this ${type} of ${amount?.toLocaleString()} UGX?`;
      document.getElementById('modalConfirmBtn').textContent = 'Yes, Approve';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function openRejectModal(type, id) {
      selectedType = type;
      selectedId = id;
      
      document.getElementById('modalTitle').textContent = 'Confirm Rejection';
      document.getElementById('modalMessage').textContent = `Are you sure you want to reject this ${type}?`;
      document.getElementById('modalConfirmBtn').textContent = 'Yes, Reject';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
      selectedType = null;
      selectedId = null;
      selectedAmount = null;
      selectedUserId = null;
    }

    // ========== EXECUTE ACTION ==========
    function executeAction() {
      if (!selectedType || !selectedId) return;
      
      if (selectedType === 'deposit') {
        processDepositAction();
      } else if (selectedType === 'withdrawal') {
        processWithdrawalAction();
      }
    }

    function processDepositAction() {
      const deposits = JSON.parse(localStorage.getItem('pendingDeposits')) || [];
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      
      const index = deposits.findIndex(d => d.id == selectedId);
      
      if (index !== -1) {
        if (document.getElementById('modalConfirmBtn').textContent === 'Yes, Approve') {
          // Approve
          deposits[index].status = 'approved';
          
          // Add money to user's operating wallet
          if (users[deposits[index].userId]) {
            users[deposits[index].userId].operatingWallet = 
              (users[deposits[index].userId].operatingWallet || 0) + deposits[index].amount;
          }
          
          alert(`✅ Deposit of ${deposits[index].amount?.toLocaleString()} UGX approved`);
        } else {
          // Reject
          deposits[index].status = 'rejected';
          alert(`❌ Deposit rejected`);
        }
        
        localStorage.setItem('pendingDeposits', JSON.stringify(deposits));
        localStorage.setItem('cueUsers', JSON.stringify(users));
        
        loadAllData();
      }
      
      closeModal();
    }

    function processWithdrawalAction() {
      const withdrawals = JSON.parse(localStorage.getItem('pendingWithdrawals')) || [];
      const users = JSON.parse(localStorage.getItem('cueUsers')) || {};
      
      const index = withdrawals.findIndex(w => w.id == selectedId);
      
      if (index !== -1) {
        if (document.getElementById('modalConfirmBtn').textContent === 'Yes, Approve') {
          // Approve - money already deducted when request was made
          withdrawals[index].status = 'approved';
          alert(`✅ Withdrawal of ${withdrawals[index].amount?.toLocaleString()} UGX approved`);
        } else {
          // Reject - refund the money
          const withdrawal = withdrawals[index];
          if (users[withdrawal.userId]) {
            if (withdrawal.wallet === 'operating') {
              users[withdrawal.userId].operatingWallet = 
                (users[withdrawal.userId].operatingWallet || 0) + withdrawal.amount;
            } else {
              users[withdrawal.userId].incentiveWallet = 
                (users[withdrawal.userId].incentiveWallet || 0) + withdrawal.amount;
            }
          }
          withdrawals[index].status = 'rejected';
          alert(`❌ Withdrawal rejected and amount refunded`);
        }
        
        localStorage.setItem('pendingWithdrawals', JSON.stringify(withdrawals));
        localStorage.setItem('cueUsers', JSON.stringify(users));
        
        loadAllData();
      }
      
      closeModal();
    }

    // ========== AUTO REFRESH (every 30 seconds) ==========
    setInterval(() => {
      if (document.getElementById('adminDashboard').style.display === 'block') {
        loadAllData();
      }
    }, 30000);

    // ========== CHECK IF ALREADY LOGGED IN (optional) ==========
    window.onload = function() {
      // For development, you can auto-login
      // adminLogin();
    }
  </script>
</body>
</html>